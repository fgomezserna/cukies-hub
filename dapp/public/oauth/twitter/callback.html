<!DOCTYPE html>
<html>
<head>
    <title>Twitter OAuth Callback</title>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
        <h2>Connecting Twitter...</h2>
        <p>Please wait while we complete the connection.</p>
        <div id="debug" style="margin-top: 20px; font-size: 12px; color: #666;"></div>
    </div>

    <script>
        const debug = document.getElementById('debug');
        
        function log(message) {
            console.log('[Twitter Callback]', message);
            debug.innerHTML += message + '<br>';
        }
        
        log('Callback page loaded');
        log('URL: ' + window.location.href);
        
        // Extract code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const state = urlParams.get('state');
        
        log('Code: ' + (code ? 'present' : 'missing'));
        log('Error: ' + (error || 'none'));
        log('State: ' + (state || 'missing'));
        
        // Get the origin from the opener or use fallback origins
        const allowedOrigins = [
            window.opener?.location?.origin,
            'http://localhost:3000',
            'https://localhost:3000'
        ].filter(Boolean);
        
        // Try to detect production origin from referrer
        if (document.referrer) {
            try {
                const referrerOrigin = new URL(document.referrer).origin;
                allowedOrigins.push(referrerOrigin);
            } catch (e) {
                log('Could not parse referrer: ' + document.referrer);
            }
        }
        
        log('Allowed origins: ' + JSON.stringify(allowedOrigins));
        
        if (error) {
            log('Sending error to parent: ' + error);
            // Send error to parent window
            allowedOrigins.forEach(origin => {
                if (origin) {
                    window.opener?.postMessage({
                        type: 'TWITTER_OAUTH_ERROR',
                        error: error,
                        errorDescription: urlParams.get('error_description')
                    }, origin);
                }
            });
        } else if (code) {
            log('Sending success to parent with code');
            // Send code to parent window
            allowedOrigins.forEach(origin => {
                if (origin) {
                    window.opener?.postMessage({
                        type: 'TWITTER_OAUTH_SUCCESS',
                        code: code,
                        state: state
                    }, origin);
                }
            });
        } else {
            log('No code or error found in URL parameters');
            log('All URL params: ' + window.location.search);
            // No code or error
            allowedOrigins.forEach(origin => {
                if (origin) {
                    window.opener?.postMessage({
                        type: 'TWITTER_OAUTH_ERROR',
                        error: 'No authorization code received',
                        url: window.location.href
                    }, origin);
                }
            });
        }
        
        log('Message sent, closing window in 3 seconds...');
        
        // Close this popup window after a short delay for debugging
        setTimeout(() => {
            window.close();
        }, 3000);
    </script>
</body>
</html> 